% !TEX root    = colouredNet_mp.tex
% !TEX program = metafun

\usemodule[commDiag]

\startMPpage
save p, r; path p[], r[];

setupCDgrid(12, 1.5cm, 4, 2.5cm, -90) ;

draw node(p[2],  1, pnPlaceText("A")) ;
draw node(p[2],  2, pnTransitionText("T1"));
drawarrow fromtopaths.rt(0, p[2], 1, p[2], 2, "\nodeTiny{(x,i)}");
draw node(p[2],  3, pnPlaceText("B")) ;
drawarrow fromtopaths.rt(0, p[2], 2, p[2], 3, "\nodeTiny{(x,i)}");
draw node(p[2],  4, pnTransitionText("T2"));
drawarrow fromtopaths.rt(0, p[2], 3, p[2], 4, "\nodeTiny{(x,i)}");
draw node(p[2],  5, pnPlaceText("C")) ;
drawarrow fromtopaths.rt(0, p[2], 4, p[2], 5, "\nodeTiny{(x,i)}");
draw node(p[2],  6, pnTransitionText("T3"));
drawarrow fromtopaths.rt(0, p[2], 5, p[2], 6, "\nodeTiny{(x,i)}");
draw node(p[2],  7, pnPlaceText("D")) ;
drawarrow fromtopaths.rt(0, p[2], 6, p[2], 7, "\nodeTiny{(x,i)}");
draw node(p[2],  8, pnTransitionText("T4"));
drawarrow fromtopaths.rt(0, p[2], 7, p[2], 8, "\nodeTiny{(x,i)}");
draw node(p[2],  9, pnPlaceText("E")) ;
drawarrow fromtopaths.rt(0, p[2], 8, p[2], 9, "\nodeTiny{(x,i)}");
draw node(p[2], 10, pnTransitionText("T5"));
drawarrow fromtopaths.rt(0, p[2], 9, p[2],10, "\nodeTiny{(x,i)}");

draw node(p[0], 6, pnPlaceText("Res"));
nodesStackedLabel("V")(.2mm, p[0], 6.5);
nodesStackedLabel(
  "$1'r+3's+2't$"
)(.2mm, p[0], 6) shifted( -1.5cm, 0);
drawarrow pnCutNodeEnds(p[0], 6, p[2], 2)(
  pnRoundCornersAt(
    nodesAssembleLinearPath(p[0], 6, p[1], 1, p[2], 2)
  )(1)(20mm)
);
nodesStackedLabel(
  "$1'r+1's$"
)(.2mm, p[1], 2);

drawarrow pnCutNodeEnds(p[0], 6, p[2], 4)(
  pnRoundCornersAt(
    nodesAssembleLinearPath(p[0], 6, p[1], 3, p[2], 4)
  )(1)(20mm)
);
nodesStackedLabel(
  "case $x$ of", "$p => 2's$", "| $q => 1's$"
)(.2mm, p[1], 4);

drawarrow pnCutNodeEnds(p[0], 6, p[2], 6)(
  pnRoundCornersAt(
    nodesAssembleLinearPath(p[0], 6, p[1], 5.5, p[2], 6)
  )(1)(20mm)
);
nodesStackedLabel(
  "if $x=p$ then $1't$", "else empty"
)(.2mm, p[1], 5.4) shifted (.25cm, 0);

drawarrow pnCutNodeEnds(p[2], 6, p[0], 6)(
  pnRoundCornersAt(
    nodesAssembleLinearPath(p[2], 6, p[1], 6.5, p[0], 6)
  )(1)(20mm)
);
nodesStackedLabel(
  "if $x=q$ then $1't$", "else empty"
)(.2mm, p[1], 6.6) shifted( .5cm, 0);

drawarrow fromtopaths.bot(0, p[0], 6, p[2], 8, "\nodeTiny{t}") ;

drawarrow pnCutNodeEnds(p[2], 10, p[0], 6)(
  pnRoundCornersAt(
    nodesAssembleLinearPath(p[2], 10, p[1], 11, p[0], 6)
  )(1)(20mm)
);
nodesStackedLabel(
  "case $x$ of", "$p => 2's+2't$", "| $q => 2's+1't$"
)(.2mm, p[1], 10) shifted( .5cm, 0);

drawarrow pnCutNodeEnds(p[2], 10, p[2], 3)(
  pnRoundCornersAt(
    nodesAssembleLinearPath(
      p[2], 10, p[2], 11, p[4], 11, p[4], 3, p[2], 3
    )
  )(1,2,3)(5mm)
);
nodesStackedLabel(
  "if $x=p$", "then $1'(p,i+1)$", "else empty"
)(.2mm, p[3], 3.25);

drawarrow pnCutNodeEnds(p[2], 10, p[2], 1)(
  pnRoundCornersAt(
    nodesAssembleLinearPath(
      p[2], 10, p[2], 11, p[4], 11, p[4], 0.25, p[2], 0.25, p[2], 1
    )
  )(1,2,3,4)(5mm)
);
nodesStackedLabel(
  "if $x=q$", "then $1'(q,i+1)$", "else empty"
)(.2mm, p[3], 0.5) ;


\stopMPpage